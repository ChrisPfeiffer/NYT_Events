<!DOCTYPE html>
<html>

<head>
  <title>Events in New York</title>    
  <link rel="stylesheet" type="text/css" href="css/events_styles.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
</head>

<body>
  <div id="map"></div>
  <h3 class="text-center">Categories</h3>
  <br/>
  <div>
  <ul class="checkbox-grid">
    <li><input class="checkbox" type="checkbox" checked="checked" name ="Movies" id="Movies" value = "valMovies" /> <label for = "Movies">Movies</label></li>
    <li><input class="checkbox" type="checkbox" checked="checked" name ="Theater" id="Theater" value = "valTheater" /> <label for = "Theater">Theater</label></li>
    <li><input class="checkbox" type="checkbox" checked="checked" name ="Art" id="Art" value = "valArt" /> <label for = "Art">Art</label></li>
    <li><input class="checkbox" type="checkbox" checked="checked" name ="spareTimes" id="spareTimes" value = "valspareTimes" /> <label for = "spareTimes">Spare Times</label></li>
    <li><input class="checkbox" type="checkbox" checked="checked" name ="forChildren" id="forChildren" value = "valforChildren" /> <label for = "forChildren">For Children</label></li>
    <li><input class="checkbox" type="checkbox" checked="checked" name ="Jazz" id="Jazz" value = "valJazz" /> <label for = "Jazz">Jazz</label></li>
    <li><input class="checkbox" type="checkbox" checked="checked" name ="Pop" id="Pop" value = "valPop" /> <label for = "Pop">Pop</label></li>
    <li><input class="checkbox" type="checkbox" checked="checked" name ="Dance" id="Dance" value = "valDance" /> <label for = "Dance">Dance</label></li>
    <li><input class="checkbox" type="checkbox" checked="checked" name ="Comedy" id="Comedy" value = "valComedy" /> <label for = "Comedy">Comedy</label></li>
    <li><input class="checkbox" type="checkbox" checked="checked" name ="Classical" id="Classical" value = "valClassical" /> <label for = "Classical">Classical</label></li>
    <li>&nbsp</li>
    <li>&nbsp</li>
  </ul>    
  </div>
  <br/>
  <br/>
  <div>
    <h3>Boroughs</h3>
  </div>
  <br/>
  <ul class="checkbox-grid">
    <li><input class="checkbox" checked="checked" type="checkbox" name="Manhattan" id="Manhattan" value="valManhattan"/><label for = "Manhattan">Manhattan</label></li>
    <li><input class="checkbox" checked="checked" type="checkbox" name="Brooklyn" id="Brooklyn" value="valBrooklyn"/><label for = "Brooklyn">Brooklyn</label></li>
    <li><input class="checkbox" checked="checked" type="checkbox" name="Queens" id="Queens" value="valQueens"/><label for = "Queens">Queens</label></li>
    <li><input class="checkbox" checked="checked" type="checkbox" name="Bronx" id="Bronx" value="valBronx"/><label for = "Bronx">Bronx</label></li>
    <li><input class="checkbox" checked="checked" type="checkbox" name="TheBronx" id="TheBronx" value="valTheBronx"/><label for = "TheBronx">The Bronx</label></li>
    <li><input class="checkbox" checked="checked" type="checkbox" name="StatenIsland" id="StatenIsland" value="valStatenIsland"/><label for = "StatenIsland">Staten Island</label></li>
  </ul>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>  
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5_EfcE8JN5H8FFL1eTYUTahS-jIeYp6U&sensor=true"></script>
  
  <!--create th map opject-->
  <script type="text/javascript">

  //builds the url based on the location of the center of the map and the state of the checkboxes
  function buildUrl(center)
  {
    var url = "http://events2339.azurewebsites.net/api/events/getevents?parameters=ll="+center.G+","+center.K+"&facetSearch=category:(";
    if($('#Movies').is(':checked')){url=url+"Movies"}
    if($('#Theater').is(':checked')){url=url+"+Theater"}
    if($('#Art').is(':checked')){url=url+"+Art"}
    if($('#spareTimes').is(':checked')){url=url+"+spareTimes"}
    if($('#forChildren').is(':checked')){url=url+"+forChildren"}
    if($('#Jazz').is(':checked')){url=url+"+Jazz"}
    if($('#Pop').is(':checked')){url=url+"+Pop"}
    if($('#Dance').is(':checked')){url=url+"+Dance"}
    if($('#Comedy').is(':checked')){url=url+"+Comedy"}
    if($('#Classical').is(':checked')){url=url+"+Classical"}
    url = url + "), borough:(";

    if($('#Manhattan').is(':checked')){url=url+"Manhattan"}
    if($('#Brooklyn').is(':checked')){url=url+"+Brooklyn"}
    if($('#Queens').is(':checked')){url=url+"+Queens"}
    if($('#Bronx').is(':checked')){url=url+"+Bronx"}
    if($('#TheBronx').is(':checked')){url=url+"+The Bronx"}
    if($('#StatenIsland').is(':checked')){url=url+"+Staten Island"}
    url=url+")";

    return url;
  }

  $(document).ready(initMap);

  var map;
  var markers = [];
  var center;
  var infoWindows = [];

  function refreshMap(url)
  {
      $.getJSON(url, function (jsonPayload) {
      $.each(jsonPayload, function(i, item){
        var infoWindow = new google.maps.InfoWindow({
          content: item.web_description
        });
        var marker = new google.maps.Marker({
          position: {lat: parseFloat(item.geocode_latitude), lng: parseFloat(item.geocode_longitude)},
          map: map,
          title: item.event_name
        });

        marker.addListener('click', function(){
          infoWindow.open(map, marker);
        });

        markers.push(marker);
        infoWindows.push(infoWindow);

      });
    });
  }

  function initMap() {
    var latlng = new google.maps.LatLng(40.7127,-74.0059);
    var options = {
      zoom: 15,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    map = new google.maps.Map(document.getElementById('map'), options);

    var url = buildUrl(map.getCenter());//"http://events2339.azurewebsites.net/api/events/getevents?parameters=ll=40.7127,-74.0059&radius=5000";
    
    refreshMap(url);

    function setMapOnAll(map) {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(map);
      }
    }

    function clearMarkers() {
     setMapOnAll(null);
     }

   map.addListener('idle', function()
   {

    center = map.getCenter();

    var url = buildUrl(center);//"http://events2339.azurewebsites.net/api/events/getevents?parameters=ll="+center.G+","+center.K+"&radius=5000";

    clearMarkers();
    markers = [];
    infoWindows = [];

    refreshMap(url);

    console.log(center);
  });

   //the change of a checkbox should cause a new call to the server   
   $('.checkbox').change(function(){
      
      var url = buildUrl(center);

      clearMarkers();
      markers = [];
      infoWindows = [];

      refreshMap(url);   

   });

 };

 </script>
</body>
</html>